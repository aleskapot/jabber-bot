services:
  # Jabber Bot service
  jabber-bot:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${JABBER_BOT_VERSION:-1.0.0}
        BUILD_TIME: ${BUILD_TIME:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        GIT_COMMIT: ${GIT_COMMIT:-$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')}
    image: jabber-bot:${JABBER_BOT_VERSION:-1.0.0}
    container_name: jabber-bot
    restart: unless-stopped
    ports:
      - "${JABBER_BOT_API_PORT:-8080}:8080"
    environment:
      # XMPP Configuration
      - JABBER_BOT_XMPP_JID=${JABBER_BOT_XMPP_JID}
      - JABBER_BOT_XMPP_PASSWORD=${JABBER_BOT_XMPP_PASSWORD}
      - JABBER_BOT_XMPP_SERVER=${JABBER_BOT_XMPP_SERVER:-localhost:5222}
      - JABBER_BOT_XMPP_RESOURCE=${JABBER_BOT_XMPP_RESOURCE:-bot}
      
      # Webhook Configuration
      - JABBER_BOT_WEBHOOK_URL=${JABBER_BOT_WEBHOOK_URL}
      - JABBER_BOT_WEBHOOK_TIMEOUT=${JABBER_BOT_WEBHOOK_TIMEOUT:-30s}
      - JABBER_BOT_WEBHOOK_RETRY_ATTEMPTS=${JABBER_BOT_WEBHOOK_RETRY_ATTEMPTS:-3}
      
      # Logging Configuration
      - JABBER_BOT_LOGGING_LEVEL=${JABBER_BOT_LOGGING_LEVEL:-info}
      - JABBER_BOT_LOGGING_OUTPUT=${JABBER_BOT_LOGGING_OUTPUT:-stdout}
      
      # API Configuration
      - JABBER_BOT_API_API_KEY=${JABBER_BOT_API_API_KEY:-}
      
      # Reconnection Configuration
      - JABBER_BOT_RECONNECTION_ENABLED=${JABBER_BOT_RECONNECTION_ENABLED:-true}
      - JABBER_BOT_RECONNECTION_MAX_ATTEMPTS=${JABBER_BOT_RECONNECTION_MAX_ATTEMPTS:-5}
      - JABBER_BOT_RECONNECTION_BACKOFF=${JABBER_BOT_RECONNECTION_BACKOFF:-5s}
#    volumes:
#      - ./configs/config.yaml:/app/configs/config.yaml:ro
#      - ./logs:/app/logs
#      - ./data:/app/data
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s